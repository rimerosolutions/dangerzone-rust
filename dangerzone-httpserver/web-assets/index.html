<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta name="author" content="Rimero Solutions Inc."/>
    <meta name="application-name" content="dangerzone-spa"/>
    <meta name="description" content="Dangerzone Web app"/>
    <title>Dangerzone Web</title>
    <script>
      function toggleOcrCheckbox(source) {
        let ocrLangSelect = document.getElementById("ocrLangSelect");
        ocrLangSelect.disabled = !(source.checked);
      }

      function toggleSubmit(source) {
        let suspiciousDocFiles = source.files;
        let submitButton = document.getElementById("submitButton");
        submitButton.disabled = (suspiciousDocFiles.length == 0);

        let eventList = document.getElementById("eventList");
        let resultSpan = document.getElementById("resultSpan");
        let downloadLink = document.getElementById("downloadLink");
        let progressContainer = document.getElementById("progressContainer");
        let progressbar = document.getElementById("progressbar");

        downloadLink.innerText = "";
        downloadLink.title = "";
        downloadLink.href = "#";
        eventList.innerHTML = "";
        resultSpan.innerText = "";
        progressContainer.className = "invisible";
        progressbar.value = 0;
      }

      function submitForm(source) {
        source.disabled = true;
        let suspiciousDocFiles = document.getElementById("fileButton").files;
        let eventList = document.getElementById("eventList");
        let resultSpan = document.getElementById("resultSpan");
        let downloadLink = document.getElementById("downloadLink");
        let ocrCheckbox = document.getElementById("ocrCheckbox");
        let ocrLangSelect = document.getElementById("ocrLangSelect");
        let progressContainer = document.getElementById("progressContainer");
        let progressbar = document.getElementById("progressbar");

        let file = suspiciousDocFiles[0];
        let filename = file.name;
        let uploadForm = document.getElementById("uploadForm");
        let uploadUrl = uploadForm.action;

        let formData = new FormData();
        formData.append("file", file);
        formData.append("filename", filename);

        if (ocrCheckbox.checked) {
          formData.append("ocrlang", ocrLangSelect.value);
        }

        fetch(uploadUrl, {method: "POST", body: formData })
          .then( response => {
            if (response.ok) {
              response.json().then(data => {
                let fileId = data.id
                let statusUrl = "./events/" + fileId;
                let sse = new EventSource(statusUrl);
                progressContainer.className = "visible";

                function onComplete() {                  
                  progressContainer.className = "invisible";
                  progressbar.value = 0;
                }

                function handleSseError() {
                  uploadForm.reset();
                  resultSpan.innerText = "The conversion failed!";
                  resultSpan.className = "error";
                  sse.close();
                  onComplete();
                }

                sse.addEventListener("processing_success", function(e) {
                  uploadForm.reset();
                  resultSpan.innerText = "The conversion succeeded!";
                  resultSpan.className = "success";
                  downloadLink.innerText = "Download trusted PDF here.";
                  downloadLink.title = "Once downloaded, the PDF will be permanently deleted from the server.";
                  downloadLink.href = "./downloads/" + fileId;
                  sse.close();                  
                  onComplete();
                });

                sse.addEventListener("processing_failure", function(e) {
                  handleSseError();
                });

                sse.addEventListener("error", function(e) {
                  handleSseError();
                });

                sse.addEventListener("processing_update", function(e) {
                  let eventNode = document.createElement("li");
                  let ndata = e.data;

                  try {
                    let n = JSON.parse(ndata);

                    if (n != undefined) {
                      eventNode.innerText = n.data;

                      if (n.percent_complete != 0) {
                        progressbar.value = n.percent_complete;
                      }
                    } else {
                      eventNode.innerText = ndata;
                    }
                  } catch (e) {
                    eventNode.innerText = ndata;
                  }

                  eventList.appendChild(eventNode);
                  eventList.scrollTop = eventList.scrollHeight;
                });
              });
            } else {
              alert("Could not upload file!\n" + response.statusText);
            }
          });
      }

      function doResizeWindow() {
        let newRows = (Math.max(document.documentElement.clientHeight, window.innerHeight || 0) * 0.4).toFixed(0);
        let eventList = document.getElementById("eventList");
        eventList.style.height = newRows + "px";
      }

      window.addEventListener("resize", function(event) {
        doResizeWindow();
      }, true);
      
      window.addEventListener("DOMContentLoaded", function(event) {
        doResizeWindow();
      }, true);
    </script>

    <style>
      .title-text {
          text-align: center;
          color: maroon;
          font-size: 1em;
          font-weight: bold;
      }

      .header-text {
          position:absolute;
          background: #977c27;
          text-align:left;
          margin-left: 1%;
          color: yellow;
          border: 5px solid #977c27;
      }

      .success {
          font-weight: bold;
          color: green;
      }

      .error {
          font-weight: bold;
          color: red;
      }

      .invisible {
          display: none;
      }

      .visible {
          display: visible;
      }

      fieldset {
          background: cyan;
          border: 5px solid blue;
      }

      legend {
          padding: 10px;
          background: blue;
          color: cyan;
      }

      #eventList {
          overflow: auto;
          margin: 0;
          padding: 10px 1px 1px 1px;
          background: yellow;
          border: 5px solid #977c27;
          font-family: monospace;
      }

      #eventList li {
          list-style-type: none;
          text-align: left;
          margin: 0;
          padding: 0;
      }

      #submitButton {
          background-color: #555555;
          border: none;
          color: white;
          margin-left: 1%;
          padding: 15px 32px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
      }

      #submitButton:hover {
          background-color: #000000;
      }

      #submitButton:disabled, #submitButton[disabled]{
          border: 1px solid #999999;
          background-color: #cccccc;
          color: #666666;
      }
    </style>
  </head>

  <body>
    <noscript>Your browser does not support JavaScript!</noscript>
    <p class="title-text">Dangerzone Web</p>
    <div>
      <span id="resultSpan"></span> &nbsp;&nbsp;
      <a id="downloadLink" href="#" target="_blank" rel="noopener noreferer"></a>
    </div>
    <br/>
    <div>
      <form id="uploadForm" action="./upload" method="post" enctype="multipart/form-data">
        <fieldset>
          <legend>Conversion Options</legend>
          <div>
            <input type="file" name="fileButton" id="fileButton" onchange="toggleSubmit(this)">
          </div>
          <div>
            <input type="checkbox" id="ocrCheckbox" name="ocr" onchange="toggleOcrCheckbox(this)">
            <label for="ocrCheckbox">Make PDF searchable?</label>
          </div>
          <div>
            <label for="ocrLangSelect">OCR language</label>
            <select id="ocrLangSelect" name="ocrLangSelect" disabled>
              <option value="ar">Afrikaans</option>
              <option value="sqi">Albanian</option>
              <option value="amh">Amharic</option>
              <option value="ara">Arabic</option>
              <option value="Arabic">Arabic script</option>
              <option value="hye">Armenian</option>
              <option value="Armenian">Armenian script</option>
              <option value="asm">Assamese</option>
              <option value="aze">Azerbaijani</option>
              <option value="aze_cyrl">Azerbaijani (Cyrillic)</option>
              <option value="eus">Basque</option>
              <option value="bel">Belarusian</option>
              <option value="ben">Bengali</option>
              <option value="Bengali">Bengali script</option>
              <option value="bos">Bosnian</option>
              <option value="bre">Breton</option>
              <option value="bul">Bulgarian</option>
              <option value="mya">Burmese</option>
              <option value="Canadian_Aboriginal">Canadian Aboriginal script</option>
              <option value="cat">Catalan</option>
              <option value="ceb">Cebuano</option>
              <option value="chr">Cherokee</option>
              <option value="Cherokee">Cherokee script</option>
              <option value="chi_sim">Chinese - Simplified</option>
              <option value="chi_sim_vert">Chinese - Simplified (vertical)</option>
              <option value="chi_tra">Chinese - Traditional</option>
              <option value="chi_tra_vert">Chinese - Traditional (vertical)</option>
              <option value="cos">Corsican</option>
              <option value="hrv">Croatian</option>
              <option value="Cyrillic">Cyrillic script</option>
              <option value="ces">Czech</option>
              <option value="dan">Danish</option>
              <option value="Devanagari">Devanagari script</option>
              <option value="div">Divehi</option>
              <option value="nld">Dutch</option>
              <option value="dzo">Dzongkha</option>
              <option value="eng" selected>English</option>
              <option value="enm">English, Middle (1100-1500)</option>
              <option value="epo">Esperanto</option>
              <option value="est">Estonian</option>
              <option value="Ethiopic">Ethiopic script</option>
              <option value="fao">Faroese</option>
              <option value="fil">Filipino</option>
              <option value="fin">Finnish</option>
              <option value="Fraktur">Fraktur script</option>
              <option value="frk">Frankish</option>
              <option value="fra">French</option>
              <option value="frm">French, Middle (ca.1400-1600)</option>
              <option value="fry">Frisian (Western)</option>
              <option value="gla">Gaelic (Scots)</option>
              <option value="glg">Galician</option>
              <option value="kat">Georgian</option>
              <option value="Georgian">Georgian script</option>
              <option value="deu">German</option>
              <option value="ell">Greek</option>
              <option value="Greek">Greek script</option>
              <option value="guj">Gujarati</option>
              <option value="Gujarati">Gujarati script</option>
              <option value="Gurmukhi">Gurmukhi script</option>
              <option value="Hangul">Hangul script</option>
              <option value="Hangul_vert">Hangul (vertical) script</option>
              <option value="HanS">Han - Simplified script</option>
              <option value="HanS_vert">Han - Simplified (vertical) script</option>
              <option value="HanT">Han - Traditional script</option>
              <option value="HanT_vert">Han - Traditional (vertical) script</option>
              <option value="hat">Hatian</option>
              <option value="heb">Hebrew</option>
              <option value="Hebrew">Hebrew script</option>
              <option value="hin">Hindi</option>
              <option value="hun">Hungarian</option>
              <option value="isl">Icelandic</option>
              <option value="ind">Indonesian</option>
              <option value="iku">Inuktitut</option>
              <option value="gle">Irish</option>
              <option value="ita">Italian</option>
              <option value="ita_old">Italian - Old</option>
              <option value="jpn">Japanese</option>
              <option value="Japanese">Japanese script</option>
              <option value="jpn_vert">Japanese (vertical)</option>
              <option value="Japanese_vert">Japanese (vertical) script</option>
              <option value="jav">Javanese</option>
              <option value="kan">Kannada</option>
              <option value="Kannada">Kannada script</option>
              <option value="kaz">Kazakh</option>
              <option value="khm">Khmer</option>
              <option value="Khmer">Khmer script</option>
              <option value="kor">Korean</option>
              <option value="kor_vert">Korean (vertical)</option>
              <option value="kur_ara">Kurdish (Arabic)</option>
              <option value="kir">Kyrgyz</option>
              <option value="lao">Lao</option>
              <option value="Lao">Lao script</option>
              <option value="lat">Latin</option>
              <option value="Latin">Latin script</option>
              <option value="lav">Latvian</option>
              <option value="lit">Lithuanian</option>
              <option value="ltz">Luxembourgish</option>
              <option value="mkd">Macedonian</option>
              <option value="mal">Malayalam</option>
              <option value="Malayalam">Malayalam script</option>
              <option value="msa">Malay</option>
              <option value="mlt">Maltese</option>
              <option value="mri">Maori</option>
              <option value="mar">Marathi</option>
              <option value="mon">Mongolian</option>
              <option value="Myanmar">Myanmar script</option>
              <option value="nep">Nepali</option>
              <option value="nor">Norwegian</option>
              <option value="oci">Occitan (post 1500)</option>
              <option value="kat_old">Old Georgian</option>
              <option value="Oriya">Oriya (Odia) script</option>
              <option value="ori">Oriya</option>
              <option value="pus">Pashto</option>
              <option value="fas">Persian</option>
              <option value="pol">Polish</option>
              <option value="por">Portuguese</option>
              <option value="pan">Punjabi</option>
              <option value="que">Quechua</option>
              <option value="ron">Romanian</option>
              <option value="rus">Russian</option>
              <option value="san">Sanskrit</option>
              <option value="osd">script and orientation</option>
              <option value="srp_latn">Serbian (Latin)</option>
              <option value="srp">Serbian</option>
              <option value="snd">Sindhi</option>
              <option value="Sinhala">Sinhala script</option>
              <option value="sin">Sinhala</option>
              <option value="slk">Slovakian</option>
              <option value="slv">Slovenian</option>
              <option value="spa_old">Spanish, Castilian - Old</option>
              <option value="spa">Spanish</option>
              <option value="sun">Sundanese</option>
              <option value="swa">Swahili</option>
              <option value="swe">Swedish</option>
              <option value="Syriac">Syriac script</option>
              <option value="syr">Syriac</option>
              <option value="tgk">Tajik</option>
              <option value="Tamil">Tamil script</option>
              <option value="tam">Tamil</option>
              <option value="tat">Tatar</option>
              <option value="Telugu">Telugu script</option>
              <option value="tel">Telugu</option>
              <option value="Thaana">Thaana script</option>
              <option value="Thai">Thai script</option>
              <option value="tha">Thai</option>
              <option value="Tibetan">Tibetan script</option>
              <option value="bod">Tibetan Standard</option>
              <option value="tir">Tigrinya</option>
              <option value="ton">Tonga</option>
              <option value="tur">Turkish</option>
              <option value="ukr">Ukrainian</option>
              <option value="urd">Urdu</option>
              <option value="uig">Uyghur</option>
              <option value="uzb_cyrl">Uzbek (Cyrillic)</option>
              <option value="uzb">Uzbek</option>
              <option value="Vietnamese">Vietnamese script</option>
              <option value="vie">Vietnamese</option>
              <option value="cym">Welsh</option>
              <option value="yid">Yiddish</option>
              <option value="yor">Yoruba</option>
            </select>
          </div>
        </fieldset>
      </form>
      <p><button onclick="submitForm(this)" id="submitButton" disabled>Convert document!</button></p>
    </div>
    <hr/>
    <div id="progressContainer" class="invisible">
      <label for="progressbar">Progress:</label>
      <progress id="progressbar" value="0" max="100"></progress>
    </div>
    <div>
      <div class="header-text">Conversion Log</div>
      <div>
        <br/>
        <ul id ="eventList"></ul>
      </div>
    </div>
  </body>

</html>
